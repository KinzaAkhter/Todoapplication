# JWT Token Management in Todo Application

This document explains how JWT (JSON Web Token) authentication works in the Todo application, including token expiration and renewal mechanisms.

## Overview

The Todo application uses JWT tokens for secure authentication between the frontend and backend. Tokens are generated by Better Auth and validated by the backend middleware.

## Token Structure

JWT tokens contain the following claims:
- `id`: User's unique identifier
- `exp`: Expiration timestamp
- `iat`: Issued at timestamp
- Other standard JWT claims

## Token Expiration

### Backend Configuration
- Default expiration: 7 days (configurable via `JWT_EXPIRE_DAYS` environment variable)
- Algorithm: HS256 (configurable via `JWT_ALGORITHM` environment variable)
- Secret: Shared via `BETTER_AUTH_SECRET` environment variable

### Frontend Handling
- Tokens are stored in browser's secure storage
- Tokens are included in the Authorization header for API requests
- Token refresh logic is handled by Better Auth client

## Token Renewal Process

### Automatic Renewal
1. Better Auth handles token renewal automatically when needed
2. When a token is close to expiration, Better Auth refreshes it seamlessly
3. The frontend API client includes logic to retry requests with fresh tokens

### Manual Renewal (if needed)
If manual token renewal is required, the application follows this process:
1. Detect 401 Unauthorized responses
2. Request a fresh session from Better Auth
3. Retry the original request with the new token (once)

## Security Considerations

### Token Validation
- All backend endpoints validate JWT tokens before processing requests
- User ID is extracted from the token to ensure data isolation
- Invalid or expired tokens result in 401 Unauthorized responses

### Session Management
- Sessions are managed by Better Auth
- Proper logout functionality clears tokens from the frontend
- Concurrent session handling prevents token reuse attacks

## Error Handling

When token-related errors occur, the application handles them appropriately:

- **Expired Token**: User is redirected to login page
- **Invalid Token**: Clear error message and redirect to login
- **Token Refresh Failure**: User must re-authenticate

## API Implementation

### Backend Middleware
The JWT middleware (`backend/middleware/jwt_auth.py`) provides:
- Token verification using the shared secret
- User data extraction from the token
- Proper error responses for invalid tokens

### Frontend API Client
The API client (`frontend/src/lib/api.ts`) includes:
- Automatic token inclusion in requests
- Retry logic for token refresh
- Specific error handling for authentication failures

## Configuration

### Environment Variables
- `BETTER_AUTH_SECRET`: Shared secret for JWT signing (must match between frontend and backend)
- `JWT_EXPIRE_DAYS`: Token expiration period in days
- `JWT_ALGORITHM`: Algorithm used for signing (default: HS256)

## Testing Token Expiration

To test token expiration behavior:

1. Generate a token with a short expiration time (e.g., 1 minute)
2. Make API requests and verify they work while token is valid
3. Wait for token to expire
4. Make another API request and verify it fails with 401
5. Verify that the frontend handles the 401 appropriately (redirect to login)

## Best Practices

- Keep `BETTER_AUTH_SECRET` secure and never expose it in client-side code
- Use HTTPS in production to prevent token interception
- Implement proper session timeout handling
- Log authentication-related events for security monitoring
- Regularly rotate the JWT secret in production environments